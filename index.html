<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>한국철도역 단어대결 + 랭킹</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body { font-family: Arial; text-align: center; margin-top: 30px; background-color: #f5f5f5; }
button { padding:10px 20px; font-size:16px; cursor:pointer; margin:5px; }
#gameArea { display:none; }
#userInput { width:200px; padding:5px; font-size:16px; }
#timer { font-size:24px; margin:10px; }
#score { font-size:20px; margin:10px; }
#aiWord { font-size:18px; color:#555; margin:10px; }
#ranking { margin-top:20px; }
</style>
</head>
<body>

<h1>한국철도역 단어대결</h1>

<div id="authArea">
  <button id="loginBtn">Google 로그인</button>
</div>

<div id="gameArea">
  <p id="welcome"></p>
  <button id="startBtn">게임 시작</button>
  <div id="timer">60</div>
  <input type="text" id="userInput" placeholder="역 이름 입력">
  <button id="submitBtn">제출</button>
  <div id="aiWord"></div>
  <div id="score">점수: 0</div>
  <button id="logoutBtn">로그아웃</button>

  <div id="ranking">
    <h3>랭킹</h3>
    <ol id="rankList"></ol>
  </div>
</div>

<script>
// 🔹 Firebase 설정 (자신의 Firebase 프로젝트 정보로 교체)
const firebaseConfig = {
  apiKey: "AIzaSyDB0F7lYfMa1HF-GtbXNWdTiALKOVd8Lls",
  authDomain: "station-game-29068.firebaseapp.com",
  projectId: "station-game-29068",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// DOM
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const gameArea = document.getElementById("gameArea");
const welcome = document.getElementById("welcome");
const rankList = document.getElementById("rankList");

loginBtn.onclick = () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
};

logoutBtn.onclick = () => auth.signOut();

auth.onAuthStateChanged(user => {
  if(user){
    document.getElementById("authArea").style.display = "none";
    gameArea.style.display = "block";
    welcome.textContent = user.displayName + "님 환영합니다!";
    addUserToDB(user);
    loadRanking();
  } else {
    document.getElementById("authArea").style.display = "block";
    gameArea.style.display = "none";
  }
});

// Firestore: 사용자 추가
async function addUserToDB(user){
  const userRef = db.collection("users").doc(user.uid);
  await userRef.set({name:user.displayName, lastScore:0},{merge:true});
}

// 점수 저장 후 랭킹 업데이트
async function saveScore(user, score){
  const userRef = db.collection("users").doc(user.uid);
  await userRef.update({lastScore:score});
  loadRanking();
}

// 랭킹 로드
function loadRanking(){
  db.collection("users").orderBy("lastScore","desc").limit(10).onSnapshot(snapshot=>{
    rankList.innerHTML="";
    snapshot.docs.forEach(doc=>{
      const data = doc.data();
      const li = document.createElement("li");
      li.textContent = `${data.name} : ${data.lastScore}`;
      rankList.appendChild(li);
    });
  });
}

// ----------------- 게임 로직 -----------------
const koreanStations = ["서울","부산","대구","인천","광주","대전","울산","수원","춘천","강릉","목포","여수","제주","청주","전주","천안"];
let timer, timeLeft, score, usedStations;

const startBtn = document.getElementById("startBtn");
const timerDisplay = document.getElementById("timer");
const scoreDisplay = document.getElementById("score");
const aiWordDisplay = document.getElementById("aiWord");
const userInput = document.getElementById("userInput");
const submitBtn = document.getElementById("submitBtn");

startBtn.onclick = () => {
  timeLeft = 60; score = 0; usedStations = [];
  timerDisplay.textContent = timeLeft;
  scoreDisplay.textContent = "점수: "+score;
  aiWordDisplay.textContent = "";
  userInput.value = "";
  userInput.focus();

  timer = setInterval(() => {
    timeLeft--;
    timerDisplay.textContent = timeLeft;
    if(timeLeft<=0){
      clearInterval(timer);
      alert("시간 종료! 점수: "+score);
      saveScore(auth.currentUser, score);
    }
  },1000);
};

submitBtn.onclick = () => {
  const userWord = userInput.value.trim();
  if(!userWord || !koreanStations.includes(userWord) || usedStations.includes(userWord)){
    userInput.value=""; return;
  }

  score++; usedStations.push(userWord);

  const available = koreanStations.filter(s=>!usedStations.includes(s));
  let aiWord = "";
  if(available.length>0){
    aiWord = available[Math.floor(Math.random()*available.length)];
    usedStations.push(aiWord);
    aiWordDisplay.textContent="AI: "+aiWord;
  } else aiWordDisplay.textContent="AI: 없음";

  scoreDisplay.textContent="점수: "+score;
  userInput.value=""; userInput.focus();
};

userInput.addEventListener("keydown", e=>{
  if(e.key==="Enter") submitBtn.click();
});
</script>

</body>
</html>
