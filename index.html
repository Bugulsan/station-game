<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚂 한국철도역 이름 대기 게임 (관리자 + 랭킹)</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script> 
    <style>
        /* CSS: 스타일링 */
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f4f9;
            color: #333;
        }

        .container {
            background-color: #fff;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 90%;
            max-width: 600px;
        }

        h1 {
            color: #007bff;
            margin-bottom: 20px;
        }
        
        #timer {
            font-size: 2.5em;
            font-weight: bold;
            color: #dc3545;
            margin-bottom: 15px;
        }

        #score {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #28a745;
        }

        #message, #user-info {
            margin-bottom: 15px;
            font-weight: bold;
            min-height: 20px;
        }

        #stationInput, #timeLimitInput, #nicknameInput {
            padding: 10px;
            width: 80%;
            max-width: 300px; 
            margin-bottom: 15px;
            border: 2px solid #ccc;
            border-radius: 5px;
            font-size: 1.1em;
            text-align: center;
            box-sizing: border-box;
        }

        button {
            padding: 10px 20px;
            font-size: 1.2em;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            color: white;
            background-color: #007bff;
            transition: background-color 0.3s;
            margin: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }
        
        #gameArea {
            display: none;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #ccc;
        }

        #rankingArea {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #007bff;
        }

        #rankingList {
            list-style: none;
            padding: 0;
            text-align: left;
        }

        #rankingList li {
            background-color: #f0f8ff;
            padding: 8px 15px;
            border-radius: 5px;
            margin-bottom: 5px;
            font-weight: 500;
            border-left: 5px solid #007bff;
        }
        #rankingList li:nth-child(1) { background-color: #ffeb3b; border-left: 5px solid #ffa000; }
        #rankingList li:nth-child(2) { background-color: #e0e0e0; border-left: 5px solid #9e9e9e; }
        #rankingList li:nth-child(3) { background-color: #ffccbc; border-left: 5px solid #ff5722; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚂 한국철도역 이름 대기 게임</h1>
        <p>Google 로그인 후 닉네임을 설정하고 랭킹에 도전하세요!</p>

        <div id="user-info">로그인해주세요.</div>

        <div id="g_id_onload"
             data-client_id="9199118002-jqjoj5mn6bevt5jc0ovtohr9svmeo092.apps.googleusercontent.com" 
             data-callback="handleCredentialResponse"
             data-auto_prompt="false"
             data-ux_mode="popup"
             data-login_uri=""
        ></div>
        <div class="g_id_signin"
             data-type="standard"
             data-size="large"
             data-theme="outline"
             data-text="sign_in_with"
             data-shape="rectangular"
             data-logo_alignment="left">
        </div>

        <div id="nicknameSetup" style="display: none; margin-bottom: 20px;">
            <p>게임을 시작하기 전에 사용할 **닉네임**을 설정해주세요.</p>
            <input type="text" id="nicknameInput" placeholder="닉네임을 입력하세요" maxlength="10">
            <button id="saveNicknameButton">닉네임 저장</button>
        </div>
        
        <div id="timeLimitSetting" style="margin-top: 15px; display: none;">
             <label for="timeLimitInput" style="font-weight: bold;">제한 시간 (초):</label>
             <input type="number" id="timeLimitInput" value="20" min="10" max="300" style="width: 80px;">
        </div>
        
        <button id="startButton" style="display: none;">게임 시작!</button>
        <div id="loginPrompt" style="display: block; font-size: 1.2em; color: #dc3545;">
            Google 로그인 및 닉네임 설정이 필요합니다.
        </div>

        <div id="gameArea">
            <div id="timer">20</div>
            <div id="score">점수: 0</div>
            <div id="message"></div>
            <input type="text" id="stationInput" placeholder="역 이름을 입력하세요 (예: 서울)">
        </div>

        <button id="restartButton" style="display: none;">다시 시작</button>

        <div id="rankingArea">
            <h2>🏆 최고 기록 (로컬 랭킹) 🏆</h2>
            <button id="clearRankingButton" style="background-color: #dc3545; font-size: 1em; padding: 5px 10px; margin-bottom: 10px; display: none;"> 
                랭킹 기록 삭제 (관리자 전용)
            </button>
            <ul id="rankingList">
                <li>데이터를 불러오는 중...</li>
            </ul>
        </div>
    </div>

    <script>
        // --- 1. 전역 변수 설정 ---
        const stations = [
            '연천', '전곡', '청산', '소요산', '동두천', '보산', '동두천중앙', '지행', '덕정', 
            '덕계', '양주', '녹양', '가능', '의정부', '회룡', '망월사', '도봉산', '도봉', 
            '방학', '창동', '녹천', '월계', '광운대', '석계', '신이문', '외대앞', '회기', '청량리',
            '제기동', '신설동', '동묘앞', '동대문', '종로5가', '종로3가', '종각', '시청', '서울역', '남영',
            '용산', '노량진', '대방', '신길', '영등포', '신도림', '구로', '구일', '개봉', '오류동',
            '온수', '역곡', '소사', '부천', '중동', '송내', '부개', '부평', '백운', '동암',
            '간석', '주안', '도화', '제물포', '도원', '동인천', '인천', '가산디지털단지', '독산', '금천구청',
            '광명', '석수', '관악', '안양', '명학', '금정', '군포', '당정', '의왕', '성균관대',
            '화서', '수원', '세류', '병점', '세마', '오산대', '오산', '진위', '송탄', '서정리',
            '평택지제', '평택', '성환', '직산', '두정', '천안', '봉명', '쌍용', '아산', '탕정',
            '배방', '온양온천', '신창', '서동탄', '구미', '사곡', '왜관', '서대구', '대구', '동대구', '경산',
            '판교', '이매', '삼동', '성남', '경기광주', '초월', '곤지암', '신둔도예촌', '이천', '부발', '세종대왕룽',
            '여주', '부전', '거제해맞이', '거제', '교대', '동래', '안락', '부산원동', '재송', '센텀', '벡스코',
            '신해운대', '송정', '오시리아', '기장', '일광', '좌천', '월내', '서생', '남창', '망양', '덕하', '개운포', '태화강',
            // 더 많은 역 추가 가능
        ];

        // ⚠️⚠️⚠️ 여기를 관리자로 지정할 본인의 Google 이메일 주소로 변경하세요! ⚠️⚠️⚠️
        const noseonjohayo@gmail.com = "your.admin.email@gmail.com"; 

        let score = 0;
        let timeLeft = 20; // 기본 시간 20초로 초기화
        let timerId;
        let usedStations = new Set();
        let isGameRunning = false;
        let isLoggedIn = false;
        let userNickname = ''; 
        let userEmail = ''; // 관리자 확인용 이메일 저장

        // HTML 요소 가져오기
        const timerDisplay = document.getElementById('timer');
        const scoreDisplay = document.getElementById('score');
        const messageDisplay = document.getElementById('message');
        const stationInput = document.getElementById('stationInput');
        const startButton = document.getElementById('startButton');
        const restartButton = document.getElementById('restartButton');
        const gameArea = document.getElementById('gameArea');
        const userInfoDisplay = document.getElementById('user-info');
        const loginPrompt = document.getElementById('loginPrompt');
        const nicknameSetup = document.getElementById('nicknameSetup');
        const nicknameInput = document.getElementById('nicknameInput');
        const saveNicknameButton = document.getElementById('saveNicknameButton');
        const rankingList = document.getElementById('rankingList');
        const timeLimitSetting = document.getElementById('timeLimitSetting'); 
        const timeLimitInput = document.getElementById('timeLimitInput');     
        const clearRankingButton = document.getElementById('clearRankingButton');

        // --- 2. UTF-8 안전 디코딩 함수 (한글 닉네임 깨짐 방지) ---
        function decodeJwt(encoded) {
            let base64 = encoded.replace(/-/g, '+').replace(/_/g, '/');
            const jsonString = decodeURIComponent(
                atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join('')
            );
            return JSON.parse(jsonString);
        }
        
        // --- 3. 관리자 상태 확인 함수 ---
        function checkAdminStatus() {
            if (userEmail === ADMIN_EMAIL_ADDRESS) {
                clearRankingButton.style.display = 'block'; 
            } else {
                clearRankingButton.style.display = 'none';
            }
        }

        // --- 4. Google 로그인 콜백 함수 ---
        function handleCredentialResponse(response) {
            const credential = response.credential;
            const encodedPayload = credential.split('.')[1];
            
            try {
                const payload = decodeJwt(encodedPayload); 
                isLoggedIn = true; 
                userEmail = payload.email; // 이메일 저장
                
                userInfoDisplay.textContent = `${payload.name}님, Google 로그인 성공! 닉네임을 설정하세요.`;
                document.querySelector('.g_id_signin').style.display = 'none'; 
                loginPrompt.style.display = 'none';

                startButton.style.display = 'none'; 
                nicknameSetup.style.display = 'block';
                nicknameInput.value = payload.given_name || payload.name;
                nicknameInput.focus();
                
                checkAdminStatus(); // 로그인 시 관리자 버튼 상태 확인

            } catch (e) {
                console.error("JWT 디코딩 오류:", e);
                userInfoDisplay.textContent = "로그인 처리 중 오류가 발생했습니다. 다시 시도해 주세요.";
            }
        }

        // --- 5. 닉네임 저장 함수 ---
        function saveNickname() {
            const nick = nicknameInput.value.trim();
            if (nick.length < 2) {
                alert('닉네임은 2글자 이상 입력해주세요.');
                return;
            }

            userNickname = nick; 
            
            nicknameSetup.style.display = 'none'; 
            userInfoDisplay.textContent = `현재 사용자: ${userNickname}님`;
            
            // 닉네임 설정 완료 후 시간 설정과 시작 버튼 표시
            timeLimitSetting.style.display = 'block'; 
            startButton.style.display = 'block'; 
            startButton.focus();
        }

        // --- 6. 랭킹 로직 ---
        function loadRanking() {
            const rankingData = localStorage.getItem('railroadRanking');
            return rankingData ? JSON.parse(rankingData) : [];
        }

        function saveRanking(ranking) {
            localStorage.setItem('railroadRanking', JSON.stringify(ranking));
        }

        function displayRanking() {
            const ranking = loadRanking();
            ranking.sort((a, b) => b.score - a.score); 
            const topRanking = ranking.slice(0, 10); 

            rankingList.innerHTML = ''; 

            if (topRanking.length === 0) {
                rankingList.innerHTML = '<li>아직 기록이 없습니다.</li>';
                return;
            }

            topRanking.forEach((record, index) => {
                const li = document.createElement('li');
                li.textContent = `${index + 1}위: ${record.nickname} - ${record.score}점`;
                rankingList.appendChild(li);
            });
        }
        
        // --- 7. 관리자 전용 랭킹 초기화 함수 ---
        function clearRanking() {
            if (userEmail !== ADMIN_EMAIL_ADDRESS) {
                alert("이 기능은 사이트 창설자(관리자)만 사용할 수 있습니다.");
                return; 
            }
            
            const confirmDelete = confirm("관리자님, 정말로 저장된 모든 랭킹 기록을 삭제하시겠습니까?");
            
            if (confirmDelete) {
                localStorage.removeItem('railroadRanking'); 
                displayRanking();
                alert("모든 랭킹 기록이 삭제되었습니다.");
            }
        }

        // --- 8. 게임 로직 ---
        function countdown() {
            if (!isGameRunning) return;

            timeLeft--;
            timerDisplay.textContent = timeLeft;

            if (timeLeft <= 0) {
                endGame();
            }
        }

        function startGame() {
            if (!isLoggedIn || !userNickname) {
                alert('게임을 시작하려면 로그인 및 닉네임 설정이 필요합니다.');
                return;
            }

            const newTimeLimit = parseInt(timeLimitInput.value);
            if (isNaN(newTimeLimit) || newTimeLimit < 10 || newTimeLimit > 300) {
                alert('제한 시간은 10초에서 300초 사이의 숫자로 입력해주세요.');
                return;
            }
            
            if (isGameRunning) return;
            
            score = 0;
            timeLeft = newTimeLimit; // 설정된 시간으로 시작!
            usedStations.clear();
            isGameRunning = true;

            scoreDisplay.textContent = `점수: 0`;
            timerDisplay.textContent = timeLeft;
            messageDisplay.textContent = '';
            stationInput.value = '';
            stationInput.disabled = false;
            stationInput.focus();
            
            startButton.style.display = 'none';
            restartButton.style.display = 'none';
            timeLimitSetting.style.display = 'none'; 
            clearRankingButton.style.display = 'none'; // 게임 중에는 관리자 버튼 숨김
            gameArea.style.display = 'block';

            timerId = setInterval(countdown, 1000);
        }

        function endGame() {
            clearInterval(timerId);
            isGameRunning = false;
            stationInput.disabled = true;

            const currentRanking = loadRanking();
            currentRanking.push({
                nickname: userNickname,
                score: score,
                date: new Date().toISOString()
            });
            saveRanking(currentRanking);
            displayRanking(); 

            messageDisplay.innerHTML = `**${userNickname}님! 게임 종료!** 최종 점수는 **${score}점** 입니다. 🎉`;
            restartButton.style.display = 'block';
            timeLimitSetting.style.display = 'block'; 
            checkAdminStatus(); // 게임 종료 후 관리자 버튼 상태 재확인
        }

        function checkInput(event) {
            if (!isGameRunning) return;
            
            if (event.key === 'Enter') {
                const input = stationInput.value.trim();
                stationInput.value = '';

                if (input === '') {
                    messageDisplay.textContent = '역 이름을 입력해주세요.';
                    return;
                }
                
                if (stations.includes(input) && !usedStations.has(input)) {
                    score++;
                    usedStations.add(input);
                    scoreDisplay.textContent = `점수: ${score}`;
                    messageDisplay.textContent = `${input} (O) 정답! 다음 역을 입력하세요.`;
                } else if (usedStations.has(input)) {
                    messageDisplay.textContent = `(X) ${input}은(는) 이미 입력했습니다.`;
                } else {
                    messageDisplay.textContent = `(X) ${input}은(는) 목록에 없는 역 이름입니다.`;
                }
            }
        }

        // --- 9. 이벤트 리스너 등록 및 초기화 ---
        startButton.addEventListener('click', startGame);
        restartButton.addEventListener('click', startGame);
        stationInput.addEventListener('keydown', checkInput);
        saveNicknameButton.addEventListener('click', saveNickname);
        clearRankingButton.addEventListener('click', clearRanking);

        window.onload = () => {
             displayRanking(); 
             userInfoDisplay.textContent = '게임을 시작하려면 Google 로그인이 필요합니다.';
             clearRankingButton.style.display = 'none'; // 초기 버튼 숨김
        };

    </script>
</body>
</html>